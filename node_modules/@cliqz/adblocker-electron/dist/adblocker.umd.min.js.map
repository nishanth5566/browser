{"version":3,"file":"adblocker.umd.min.js","sources":["esm/preload_path.js","esm/index.js"],"sourcesContent":["import { createRequire } from 'node:module';\n//@ts-ignore\nexport const PRELOAD_PATH = createRequire(import.meta.url).resolve('@cliqz/adblocker-electron-preload');\n//# sourceMappingURL=preload_path.js.map","/*!\n * Copyright (c) 2017-present Ghostery GmbH. All rights reserved.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at https://mozilla.org/MPL/2.0/.\n */\nimport * as electron from 'electron';\nimport { parse } from 'tldts-experimental';\nimport { FiltersEngine, Request } from '@cliqz/adblocker';\nimport { PRELOAD_PATH } from './preload_path.js';\nconst { ipcMain } = electron;\n// https://stackoverflow.com/questions/48854265/why-do-i-see-an-electron-security-warning-after-updating-my-electron-project-t\nprocess.env['ELECTRON_DISABLE_SECURITY_WARNINGS'] = 'true';\n/**\n * Create an instance of `Request` from `Electron.OnBeforeRequestDetails`.\n */\nexport function fromElectronDetails(details) {\n    const { id, url, resourceType, referrer, webContentsId } = details;\n    return Request.fromRawDetails(webContentsId\n        ? {\n            _originalRequestDetails: details,\n            requestId: `${id}`,\n            sourceUrl: referrer,\n            tabId: webContentsId,\n            type: (resourceType || 'other'),\n            url,\n        }\n        : {\n            _originalRequestDetails: details,\n            requestId: `${id}`,\n            sourceUrl: referrer,\n            type: (resourceType || 'other'),\n            url,\n        });\n}\n/**\n * This abstraction takes care of blocking in one instance of `Electron.Session`.\n */\nexport class BlockingContext {\n    constructor(session, blocker) {\n        this.session = session;\n        this.blocker = blocker;\n        this.onBeforeRequest = (details, callback) => blocker.onBeforeRequest(details, callback);\n        this.onGetCosmeticFiltersFirst = (event, url) => blocker.onGetCosmeticFiltersFirst(event, url);\n        this.onGetCosmeticFiltersUpdated = (event, url, msg) => blocker.onGetCosmeticFiltersUpdated(event, url, msg);\n        this.onHeadersReceived = (details, callback) => blocker.onHeadersReceived(details, callback);\n        this.onIsMutationObserverEnabled = (event) => blocker.onIsMutationObserverEnabled(event);\n    }\n    enable() {\n        if (this.blocker.config.loadCosmeticFilters === true) {\n            this.session.setPreloads(this.session.getPreloads().concat([PRELOAD_PATH]));\n            ipcMain.on('get-cosmetic-filters-first', this.onGetCosmeticFiltersFirst);\n            ipcMain.on('get-cosmetic-filters', this.onGetCosmeticFiltersUpdated);\n            ipcMain.on('is-mutation-observer-enabled', this.onIsMutationObserverEnabled);\n        }\n        if (this.blocker.config.loadNetworkFilters === true) {\n            this.session.webRequest.onHeadersReceived({ urls: ['<all_urls>'] }, this.onHeadersReceived);\n            this.session.webRequest.onBeforeRequest({ urls: ['<all_urls>'] }, this.onBeforeRequest);\n        }\n    }\n    disable() {\n        if (this.blocker.config.loadNetworkFilters === true) {\n            // NOTE - there is currently no support in Electron for multiple\n            // webRequest listeners registered for the same event. This means that\n            // adblocker's listeners can be overriden by other ones in the same\n            // application (or that the adblocker can override another listener\n            // registered previously). Because of this, the only way to disable the\n            // adblocker is to remove all listeners for the events we are interested\n            // in. In the future, we should consider implementing a webRequest\n            // pipeline allowing to register multiple listeners for the same event.\n            this.session.webRequest.onHeadersReceived(null);\n            this.session.webRequest.onBeforeRequest(null);\n        }\n        if (this.blocker.config.loadCosmeticFilters === true) {\n            this.session.setPreloads(this.session.getPreloads().filter((p) => p !== PRELOAD_PATH));\n            ipcMain.removeListener('get-cosmetic-filters', this.onGetCosmeticFiltersUpdated);\n        }\n    }\n}\n/**\n * Wrap `FiltersEngine` into a Electron-friendly helper class. It exposes\n * methods to interface with Electron APIs needed to block ads.\n */\nexport class ElectronBlocker extends FiltersEngine {\n    constructor() {\n        super(...arguments);\n        this.contexts = new WeakMap();\n        // ----------------------------------------------------------------------- //\n        // ElectronBlocker-specific additions to FiltersEngine\n        // ----------------------------------------------------------------------- //\n        this.onIsMutationObserverEnabled = (event) => {\n            event.returnValue = this.config.enableMutationObserver;\n        };\n        this.onGetCosmeticFiltersFirst = (event, url) => {\n            // Extract hostname from sender's URL\n            const parsed = parse(url);\n            const hostname = parsed.hostname || '';\n            const domain = parsed.domain || '';\n            const { active, styles, scripts, extended } = this.getCosmeticsFilters({\n                domain,\n                hostname,\n                url,\n                // This needs to be done only once per frame\n                getBaseRules: true,\n                getInjectionRules: true,\n                getExtendedRules: true,\n                getRulesFromHostname: true,\n                getRulesFromDOM: false, // Only done on updates (see `onGetCosmeticFiltersUpdated`)\n                callerContext: {\n                    frameId: event.frameId,\n                    processId: event.processId,\n                },\n            });\n            if (active === false) {\n                event.returnValue = null;\n                return;\n            }\n            // Inject custom stylesheets\n            this.injectStyles(event.sender, styles);\n            event.sender.send('get-cosmetic-filters-response', {\n                active,\n                extended,\n                styles: '',\n            });\n            // to execute Inject scripts synchronously, simply return scripts to renderer.\n            event.returnValue = scripts;\n        };\n        this.onGetCosmeticFiltersUpdated = (event, url, msg) => {\n            // Extract hostname from sender's URL\n            const parsed = parse(url);\n            const hostname = parsed.hostname || '';\n            const domain = parsed.domain || '';\n            const { active, styles, extended } = this.getCosmeticsFilters({\n                domain,\n                hostname,\n                url,\n                classes: msg.classes,\n                hrefs: msg.hrefs,\n                ids: msg.ids,\n                // Only done on first load in the frame, disable for updates\n                getBaseRules: false,\n                getInjectionRules: false,\n                getExtendedRules: false,\n                getRulesFromHostname: false,\n                // This will be done every time we get information about DOM mutation\n                getRulesFromDOM: true,\n                callerContext: {\n                    frameId: event.frameId,\n                    processId: event.processId,\n                    lifecycle: msg.lifecycle,\n                },\n            });\n            if (active === false) {\n                return;\n            }\n            // Inject custom stylesheets\n            this.injectStyles(event.sender, styles);\n            // Inject scripts from content script\n            event.sender.send('get-cosmetic-filters-response', {\n                active,\n                extended,\n                styles: '',\n            });\n        };\n        this.onHeadersReceived = (details, callback) => {\n            const CSP_HEADER_NAME = 'content-security-policy';\n            const policies = [];\n            const responseHeaders = details.responseHeaders || {};\n            if (details.resourceType === 'mainFrame' || details.resourceType === 'subFrame') {\n                const rawCSP = this.getCSPDirectives(fromElectronDetails(details));\n                if (rawCSP !== undefined) {\n                    policies.push(...rawCSP.split(';').map((csp) => csp.trim()));\n                    // Collect existing CSP headers from response\n                    for (const [name, values] of Object.entries(responseHeaders)) {\n                        if (name.toLowerCase() === CSP_HEADER_NAME) {\n                            policies.push(...values);\n                            delete responseHeaders[name];\n                        }\n                    }\n                    responseHeaders[CSP_HEADER_NAME] = [policies.join(';')];\n                    callback({ responseHeaders });\n                    return;\n                }\n            }\n            callback({});\n        };\n        this.onBeforeRequest = (details, callback) => {\n            const request = fromElectronDetails(details);\n            if (this.config.guessRequestTypeFromUrl === true && request.type === 'other') {\n                request.guessTypeOfRequest();\n            }\n            if (request.isMainFrame()) {\n                callback({});\n                return;\n            }\n            const { redirect, match } = this.match(request);\n            if (redirect) {\n                callback({ redirectURL: redirect.dataUrl });\n            }\n            else if (match) {\n                callback({ cancel: true });\n            }\n            else {\n                callback({});\n            }\n        };\n    }\n    // ----------------------------------------------------------------------- //\n    // Helpers to enable and disable blocking for 'browser'\n    // ----------------------------------------------------------------------- //\n    enableBlockingInSession(session) {\n        let context = this.contexts.get(session);\n        if (context !== undefined) {\n            return context;\n        }\n        // Create new blocking context for `session`\n        context = new BlockingContext(session, this);\n        this.contexts.set(session, context);\n        context.enable();\n        return context;\n    }\n    disableBlockingInSession(session) {\n        const context = this.contexts.get(session);\n        if (context === undefined) {\n            throw new Error('Trying to disable blocking which was not enabled');\n        }\n        this.contexts.delete(session);\n        context.disable();\n    }\n    isBlockingEnabled(session) {\n        return this.contexts.has(session);\n    }\n    injectStyles(sender, styles) {\n        if (styles.length > 0) {\n            sender.insertCSS(styles, {\n                cssOrigin: 'user',\n            });\n        }\n    }\n}\n// re-export @cliqz/adblocker symbols for convenience\nexport * from '@cliqz/adblocker';\n//# sourceMappingURL=index.js.map"],"names":["PRELOAD_PATH","createRequire","document","location","require","pathToFileURL","__filename","href","_documentCurrentScript","tagName","toUpperCase","src","URL","baseURI","resolve","ipcMain","electron","fromElectronDetails","details","id","url","resourceType","referrer","webContentsId","Request","fromRawDetails","_originalRequestDetails","requestId","sourceUrl","tabId","type","process","env","BlockingContext","constructor","session","blocker","this","onBeforeRequest","callback","onGetCosmeticFiltersFirst","event","onGetCosmeticFiltersUpdated","msg","onHeadersReceived","onIsMutationObserverEnabled","enable","config","loadCosmeticFilters","setPreloads","getPreloads","concat","on","loadNetworkFilters","webRequest","urls","disable","filter","p","removeListener","ElectronBlocker","FiltersEngine","super","arguments","contexts","WeakMap","returnValue","enableMutationObserver","parsed","parse","hostname","domain","active","styles","scripts","extended","getCosmeticsFilters","getBaseRules","getInjectionRules","getExtendedRules","getRulesFromHostname","getRulesFromDOM","callerContext","frameId","processId","injectStyles","sender","send","classes","hrefs","ids","lifecycle","CSP_HEADER_NAME","policies","responseHeaders","rawCSP","getCSPDirectives","undefined","push","split","map","csp","trim","name","values","Object","entries","toLowerCase","join","request","guessRequestTypeFromUrl","guessTypeOfRequest","isMainFrame","redirect","match","redirectURL","dataUrl","cancel","enableBlockingInSession","context","get","set","disableBlockingInSession","Error","delete","isBlockingEnabled","has","length","insertCSS","cssOrigin"],"mappings":"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"}